<!DOCTYPE html>
<html>
<head>
  <title>NeuroDataViz: viewing {{ project_name }}</title>
  {% load staticfiles %}
  {# boostrap files #}
  <link rel="stylesheet" type ="text/css" href="{% static 'bootstrap/css/bootstrap.css' %}" />

  {# jquery UI #}
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">

  {# leaflet files #}
  <link rel="stylesheet" href="{% static 'ndv/leaflet/leaflet.css' %}" />

  {# buttons, buttons, buttons #}
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  {# css file #}
  <link rel="stylesheet" href="{% static 'ndv/css/viewer.css' %}" />

  {% if GOOGLE_ANALYTICS_PROPERTY_ID %}
    {% include "ndv/analytics.html" %}
  {% endif %}

  <script src="{% static 'ndv/leaflet/leaflet.js' %}"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="{% static "ndv/js/easy-button.js" %}"></script>
  <script src="{% static "ndv/js/ocp-leaflet.js" %}"></script>
	</head>
<body>


  {# Begin Modal Code Includes #}
  {% include "ndv/help.html" %}

  {% include "ndv/nav.html" %}

  {% include "ndv/add_data.html" %}

  {% include "ndv/dataview.html" %}

  {% include "ndv/login.html" %}
  {# End Modal Code Includes #}

  <div id="map"></div>
  <script>

    // global variables
    var ndv = {};
    ndv.querytool = 'false'; 
    ndv.querylayer = 'none';
    ndv.querytoken = 'none';
    ndv.querychannel = 'none';
   
    // timeseries globals
    ndv.playdelay = 1;

    // marker array
    ndv.markers = [];
    
    // upsample settings
    ndv.upsample_num = 2;

    // dataset info
    ndv.xstart = {{ xstart }};
    ndv.xmin = {{ xoffset }};
    ndv.xmax = {{ xsize }} + {{ xoffset }} - 1;
  
    ndv.ystart = {{ ystart }};
    ndv.ymin = {{ yoffset }};
    ndv.ymax = {{ ysize }} + {{ yoffset }} - 1;
    
    ndv.zmin = {{ zoffset }};
    ndv.zmax = {{ zsize }} + {{ zoffset }} - 1;
    
    ndv.minres = {{ minres }};
    ndv.maxres = {{ maxres }};
    ndv.res = {{ res }};
    // set zindex to some default (we pick the lowest slice)
    ndv.zindex = {{ zstart }};

     // create the map first
		var map = L.map('map', {
			doubleClickZoom: false,
    });

    // define layers (namespaced with a layers. prefix) 
    var layers = {}; 

    // load image layers first
    {% for layer in layers %}
      {% if layer.layertype != 'annotation' %}
      {# setup the URL #}

        {% if layer.channel %}
          var webtoken = '{{ layer.token }}/{{ layer.channel }}';
          {% if layer.color %}
            webtoken = webtoken + ':{{layer.color}}';
          {% endif %}
        {% else %}
          var webtoken = '{{ layer.token }}';
        {% endif %}

        {% if layer.tilecache %}
          {% if layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}

        {% else %}
          {% if layer.color %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/mcfc/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% elif layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
        {% endif %}

        console.log(url);

        {# add the layer #}
        layers.{{ layer.layer_name|cut:" " }} = L.tileLayer.OCPLayer(
          url,
          {
            zindex: ndv.zindex,
            zoomReverse: true,
            minZoom: ndv.maxres,
            maxZoom: ndv.maxres + ndv.maxres + ndv.upsample_num,
            maxNativeZoom: ndv.maxres + ndv.maxres,
            tileSize: 512,
            {% if layer.layertype == 'annotation' %}
            opacity: 0.4,
            propagate: 2, 
            {% else %}
            propagate: {{ layer.propagate }},
            {% endif %}
            {% if layer.layertype == 'timeseries' %}
            curtime: {{ starttime }},
            {% endif %}
            //noWrap: true,
            continuousWorld: true,
          }).addTo(map);
        {% endif %}
    {% endfor %}

    // now load annotations
    {% for layer in layers %}
      {% if layer.layertype == 'annotation' %}
      {# setup the URL #}

        {% if layer.channel %}
          var webtoken = '{{ layer.token }}/{{ layer.channel }}';
          {% if layer.color %}
            webtoken = webtoken + ':{{layer.color}}';
          {% endif %}
        {% else %}
          var webtoken = '{{ layer.token }}';
        {% endif %}

        {% if layer.tilecache %}
          {% if layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}

        {% else %}
          {% if layer.color %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/mcfc/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% elif layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
        {% endif %}

        console.log(url);

        {# add the layer #}
        layers.{{ layer.layer_name|cut:" " }} = L.tileLayer.OCPLayer(
          url,
          {
            zindex: ndv.zindex,
            zoomReverse: true,
            minZoom: ndv.maxres,
            maxZoom: ndv.maxres + ndv.maxres + ndv.upsample_num,
            maxNativeZoom: ndv.maxres + ndv.maxres,
            tileSize: 512,
            {% if layer.layertype == 'annotation' %}
            opacity: 0.4,
            propagate: 2, 
            {% else %}
            propagate: {{ layer.propagate }},
            {% endif %}
            {% if layer.layertype == 'timeseries' %}
            curtime: {{ starttime }},
            {% endif %}
            //noWrap: true,
            continuousWorld: true,
          }).addTo(map);
        {% endif %}
    {% endfor %}

    // set the initial view
    var center = map.unproject(L.point( ndv.xstart, ndv.ystart ), ndv.maxres + ndv.maxres - ndv.res);
		map.setView(center, ndv.maxres + ndv.maxres - ndv.res);
    
    // BEGIN propagate warning box 
    var propwarn = L.control();
    propwarn.options.position = 'topright';
    propwarn.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'propwarnbox');
      this._div.innerHTML = '<div class="alert alert-danger" role="alert"><span class="glyphicon glyphicon-alert" aria-hidden="true"></span><span class="sr-only">Warning:</span> The following layers are not propagated: <strong><span class="notpropchanlist"></span></strong>.<br />Image data may be missing at some resolutions!';
      return this._div;
    };
    propwarn.addTo(map);

    function checkPropagate() {
      $( ".propwarnbox" ).hide();
      for (layer in layers) {
        if (layers[layer].options.propagate != 2) {
          $( ".propwarnbox" ).show();
          if ($( ".notpropchanlist" ).text().length > 0)  {
            $( ".notpropchanlist" ).append(", ");
          }
          $( ".notpropchanlist" ).append(layer);
          console.log(layers[layer].options.propagate);
        }
      }
    }
    checkPropagate();

    // END propagate warning box 

    // BEGIN query result palette
    var queryres = L.control();
    queryres.options.position = 'topright';
    queryres.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'queryres');
      var header = '<div class="closequery" style="float:right;"><a id="closequerybox" href="#"><i class="fa fa-times fa-lg"></a></i></div><h4>Query Result</h4>';
      var querybody = '<div class="querybody"></div>';
      this._div.innerHTML = header + querybody;
      return this._div;
    };
		queryres.addTo(map);

    // disable (and then re-enable) clicking on mouseover
    queryres.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    queryres.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });
    // END query result palette

    // BEGIN project info palette
    var projinfo = L.control();
    projinfo.options.position = 'topright';
    projinfo.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'projinfo');
      var showicon = '<div id="projinfoicon" style="float:left;"><a id="showprojinfo" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-info fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="projinfobox" style="display:none;">';
      var title = '<div style="float:right;"><a id="hideprojinfo" href="#"><i class="fa fa-times fa-lg"></a></i></div><div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-info fa-stack-1x"></i></span></div><div class="headertext">Project Info</div></div>';
      var projinfodiv = '<div id="projinfotxt"></div>'
      var hiddendivend = '</div>'
      this._div.innerHTML = showicon + hiddendivstart + title  + projinfodiv + hiddendivend;
			return this._div;
    };
		projinfo.addTo(map);
    $( "#showprojinfo" ).on('click', function () {
      $( "#projinfobox" ).toggle( "slow", function () {
        $( "#projinfoicon" ).toggle( );
      });
    });
    $( "#hideprojinfo" ).on('click', function () {
      $( "#projinfobox" ).toggle( "slow" , function () {
        $( "#projinfoicon" ).toggle( );
      });
    });
    // disable (and then re-enable) clicking on mouseover
    projinfo.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    projinfo.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });
    function getProjInfo() {
      // we use the token from the first layer (for now)
      var infoToken = "{{ layers.0.token }}";
      var infoUrl = "http://{{ request.get_host }}{% url 'projinfo' queryargs='placeholder' %}";
      infoUrl = infoUrl.replace('placeholder', 'localhost/' + infoToken + '/')
      
      $( "#projinfotxt" ).load(infoUrl);
		}
    getProjInfo();

    // END project info palette

    // BEGIN image control palette
    var imagecontrols = L.control();
    imagecontrols.options.position = 'topright';
    imagecontrols.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'imagecontrols');
      var showicon = '<div id="imagecontrolsshow" style="float:left;"><a id="showimagecontrols" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-picture-o fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="imagecontrolshide" style="display:none;">';
      var title = '<div style="float:right;"><a id="hideimagecontrols" href="#"><i class="fa fa-times fa-lg"></a></i></div><div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-picture-o fa-stack-1x"></i></span></div><div class="headertext">Image Controls</div></div>';

      var imgsliderdiv = '<div id="image-sliders"></div>'

      var blendmode = '<br /><div id="blendmode">Blend Mode: <select name="blendmode"><option value="normal">Normal</option><option value="multiply">Multiply</option><option value="Screen">Screen</option><option value="overlay">Overlay</option><option value="darken">Darken</option><option value="lighten">Ligten</option><option value="color-dodge">Color Dodge</option><option value="color-burn">Color Burn</option><option value="exclusion">Exclusion</option><option value="difference">Difference</option><option value="hue">Hue</option><option value="saturation">Saturation</option><option value="color">Color</option><option value="luminosity">Luminosity</option></select><span style="float: right;"><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/blend-mode" target="_blank"><i class="fa fa-info-circle fa-lg"></i></a></span></div>';

      var resolution = '<br /><div id="resolution">Resolution: <input id="res-input" type="number" min="' + (ndv.minres - ndv.upsample_num) + '" max="' + ndv.maxres + '" value="' + ndv.res + '" /></div>';

      var adddata = '<br /><div id="add_data_link"><a href="#" data-toggle="modal" data-target="#add_data">Add Data to Current View</a></div>';

      var hiddendivend = '</div>';

      this._div.innerHTML = showicon + hiddendivstart + title + imgsliderdiv + blendmode + resolution + adddata + hiddendivend;
      return this._div;
    };
    imagecontrols.addTo(map);
    // update sliders (removes all layers and adds from layers var)
    function updateImageControlSliders() {
      $( "#image-sliders" ).empty();
      for (layer in layers) {
        var tmphtml = '<div class="controls-' + layer + '"><div class="controls-layer-name"><a href="#" class="remove-layer ' + layer + '"><i class="fa fa-times-circle"></i></a><a href="#">' + layer + '</a></div><div class="controls-slider-name">Opacity</div><div id="slider"><span class="opacity">' + layer + '</span></div><br /><div id="controls-slider-name">Brightness</div><div id="slider"><span class="brightness">' + layer + '</span></div><br /><div class="controls-slider-name">Contrast</div><div id="slider"><span class="contrast">' + layer + '</span></div><br /></div>';
        $( "#image-sliders" ).append(tmphtml);
      }
      // brightness controls
      $(function() {
        $( "#slider > .brightness" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 200,
            value: 100,
            slide: function ( event, ui ) {
              layers[layer].setBrightness(ui.value);
              console.log(ui.value);
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); },
          });
        });
      });// sliders -- brightness
      // contrast controls 
      $(function() {
        $( "#slider > .contrast" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 200,
            value: 100,
            slide: function ( event, ui ) {
                layers[layer].setContrast(ui.value);
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); },
          });
        });
      });// sliders -- contrast
      // opacity controls 
      $(function() {
        $( "#slider > .opacity" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 100,
            value: layers[layer].options.opacity*100,
            slide: function ( event, ui ) {
                layers[layer].setOpacity(ui.value/100);
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); },
          });
        });
      });// sliders -- opacity
    };
    updateImageControlSliders();
    // toggle image controls
    $( "#showimagecontrols" ).on('click', function () {
      $( "#imagecontrolshide" ).toggle( "slow" );
      $( "#imagecontrolsshow" ).toggle();
    });
    $( "#hideimagecontrols" ).on('click', function () {
      $( "#imagecontrolshide" ).toggle( "slow", function () {
        $( "#imagecontrolsshow" ).toggle( );
      });
    });
    // disable (and then re-enable) clicking on mouseover
    imagecontrols.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    imagecontrols.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });
    // END image control palette

    // update current coordinates in nav box

    function coordinatesUpdate() {
      $( "#x" ).parent().removeClass("has-error");
      $( "#y" ).parent().removeClass("has-error");
      $( "#z" ).parent().removeClass("has-error");
      var center = map.getCenter();
      var res = map.getMaxZoom() - ndv.upsample_num - map.getZoom();
      var coordinates = map.project(center);

      $( "#x" ).val(Math.round(coordinates.x));
      $( "#y" ).val(Math.round(coordinates.y));
      $( "#z" ).val(ndv.zindex);
    };
    coordinatesUpdate();
    // update coordinates on pan, zoom, and load
    map.on('drag', coordinatesUpdate);
    map.on('zoomend', coordinatesUpdate);

    function resolutionUpdate() {
      $( "#res-input" ).val( map.getMaxZoom() - ndv.upsample_num - map.getZoom() );
    }

    map.on('zoomend', resolutionUpdate);

    $( "#res-input" ).on('input', function() {
      var val = $( "#res-input" ).val();
      map.setZoom( map.getMaxZoom() - ndv.upsample_num - val );
    });

    // navigation
    // first, intercept the form
    $( "#navigate" ).submit(function( event ) {
      event.preventDefault();
      // clear errors
      $( "#x" ).parent().removeClass("has-error");
      $( "#y" ).parent().removeClass("has-error");
      $( "#z" ).parent().removeClass("has-error");

      // if a valid (x,y) pair was entered, pan and place a marker
      // note, need to pan before changing slices
      if ( $( "#x" ).val() && $( "#y" ).val()) {
        var x = $( "#x" ).val();
        var y = $( "#y" ).val();

        // validate
        if ( x > ndv.xmax || x < ndv.xmin ) {
          $( "#x" ).parent().addClass("has-error");
        }
        else if ( y > ndv.ymax || y < ndv.ymin ) {
          $( "#y" ).parent().addClass("has-error");
        }
        else {
          // pan the map to center on these coordinates
          var point = L.point(x, y);
          var projpoint = map.unproject(point);

          map.panTo(projpoint);
          // place a marker
          //L.marker(projpoint).addTo(map);
        }
      }
      else {
        if ( $( "#x" ).val() && !$( "#y" ).val() ) {
          $( "#y" ).parent().addClass("has-error");
        }
        else if ( $( "#y" ).val() && !$( "#x" ).val() ) {
          $( "#x" ).parent().addClass("has-error");
        }
      }
      // if a zindex was entered, navigate to that slice
      if ( $( "#z" ).val() ) {
        var z = $( "#z" ).val();
        if (z <= ndv.zmax && z >= ndv.zmin) {
          chgZIndex(z);
        }
        else {
          $( "#z" ).parent().addClass("has-error");
        }
      }

      // handle timestep if timeseries
      {% if timeseries == True %}
        loadTimeStep( $( "#timestep" ).val() );
      {% endif %}
    });

    $( "#addmarkercenter" ).click(function( event ) {
      // place a marker at the current map center
      var center = map.getCenter();
      var point = map.project(center);
      var marker_options = {
        title: point.x + " " + point.y + " " + ndv.zindex,
      }

      // keep track of markers by storing in an array
      ndv.markers.push(L.marker(center, marker_options).addTo(map));

      // get current url
      var markerUrl = getCurrentURL(point);

      var popup_options = {
        maxWidth: 750,
      }

      ndv.markers[ndv.markers.length - 1].bindPopup('<a href="' + markerUrl + '">' + markerUrl + '</a>', popup_options);
    });

    {% if marker == True %}
      // add a marker to the center
      //L.marker(center).addTo(map);
      $( "#addmarkercenter" ).trigger('click');
    {% endif %}

    function markerOnClick(event) {
      // place a marker at the click

      var point = map.project(event.latlng);
      var marker_options = {
        title: point.x + " " + point.y + " " + ndv.zindex,
      }

      // keep track of markers by storing in an array
      ndv.markers.push(L.marker(event.latlng, marker_options).addTo(map));

      // get current url
      var markerUrl = getCurrentURL(point);
      var popup_options = {
        maxWidth: 750,
      }

      ndv.markers[ndv.markers.length - 1].bindPopup('<a href="' + markerUrl + '">' + markerUrl + '</a>', popup_options);
      map.off('click', markerOnClick);
      // turn query tool back on
      map.on('click', onMapClick);
    };

    function getCurrentURL(point) {
      var script_name = '{{ request.META.SCRIPT_NAME }}';
      var pathRaw = '{{ request.path }}';
      var pathArr = pathRaw.split('/');
      var curZoom = map.getMaxZoom() - ndv.upsample_num - map.getZoom();
      
      if (script_name == '') {
        var token = pathArr[1];
        var channels = '';
        // handle the case where we are in project view mode 
        if (token == 'project') {
          token = 'project/' + pathArr[2];
          channels = '';
        }
        else {
          if (pathArr.length > 3 && !(pathArr[2] == 'xy' || pathArr[2] == 'yz' || pathRaw[2] == 'xz')) {
            channels = pathArr[2]; 
          }
        }
        
        if (channels == '') {
          var markerUrl = "http://{{ request.get_host }}/" + token + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
        else {
          var markerUrl = "http://{{ request.get_host }}/" + token + "/" + channels + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
      }
      else {
        var token = pathArr[2];
        var channels = '';
        // handle the case where we are in project view mode 
        if (token == 'project') {
          token = 'project/' + pathArr[3];
          channels = '';
        }
        else {
          if (pathArr.length > 3 && !(pathArr[3] == 'xy' || pathArr[3] == 'yz' || pathRaw[3] == 'xz')) {
            channels = pathArr[3]; 
          }
        }
        
        if (channels == '') {
          var markerUrl = "http://{{ request.get_host }}" + script_name + "/" + token + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
        else {
          var markerUrl = "http://{{ request.get_host }}" + script_name + "/" + token + "/" + channels + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
      }
      return markerUrl;
    };

    $( "#addmarkermouse" ).click(function( event ) {
      map.on('click', markerOnClick);
      // turn off query tool
      map.off('click', onMapClick);
    });

    $( "#clearmarkers" ).click(function( event ) {
      var index;
      for (index = 0; index < ndv.markers.length; index++) {
        map.removeLayer(ndv.markers[index]);

      }
    });

		// z-index arrows
		L.easyButton('fa-arrow-up',
				incZIndex,
				'Increase Z-Index'
		);
		L.easyButton('fa-arrow-down',
				decZIndex,
				'Decrease Z-Index'
		);

    function chgZIndex(newz) {
      map.closePopup();
      var oldzindex = ndv.zindex;
			ndv.zindex = parseInt(newz);
			reloadLayers(oldzindex);
    }

		function incZIndex() {
      map.closePopup();
      var oldzindex = ndv.zindex;
      if ((ndv.zindex + 1) > ndv.zmax) {
        $( "#z" ).parent().addClass("has-error");
      }
      else {
        $( "#z" ).parent().removeClass("has-error");
        ndv.zindex = ndv.zindex + 1;
        reloadLayers(oldzindex);
      }
		}

		function decZIndex() {
      map.closePopup();
      var oldzindex = ndv.zindex;
      if ((ndv.zindex - 1) < ndv.zmin) {
        $( "#z" ).parent().addClass("has-error");
      }
      else {
        $( "#z" ).parent().removeClass("has-error");
        ndv.zindex = ndv.zindex - 1;
        reloadLayers(oldzindex);
      }
    }

		function reloadLayers() {
			map.options.fadeAnimation = false;
      map.eachLayer( function (layer) {
        if ( layer.hasOwnProperty('_url') ) {
          layer.options.zindex = ndv.zindex;
					layer.smoothRedraw();
        }
      });
      map.options.fadeAnimation = true;
      coordinatesUpdate();
		}

		// get anno id from coordinate
    // expects a L.point object for point and a number for zoom
    // TODO if the server is localhost (the query server) that doesnt work
		function getAnnoId(point, zoom) {
      var script_name = '{{ request.META.SCRIPT_NAME }}';
      if (script_name == '') {
        var ocpUrlBase = "http://{{ request.get_host }}/query/localhost/ca/" + ndv.querytoken + "/" + ndv.querychannel + "/id/" + zoom + "/";
      }
      else {
        var ocpUrlBase = "http://{{ request.get_host }}/{{ request.META.SCRIPT_NAME }}/query/localhost/ca/" + ndv.querytoken + "/" + ndv.querychannel + "/id/" + zoom + "/";
      }
			var cutout = Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
			var ocpUrl = ocpUrlBase.concat(cutout);

      // make request
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open( "GET", ocpUrl, false );
			xmlHttp.send( null );

			return xmlHttp.responseText;
		}

    function getRamonInfo(point, zoom) {
      // first, make sure that either zoom > 0 or
      // resample point and zoom to be at level 0
      if (zoom < 0) {
        var numScales = 0 - zoom;
        // scale the x and y coordinates of the point
        var x = Math.round( point.x / ( 2 * numScales ) );
        var y = Math.round( point.y / ( 2 * numScales ) );
        point.x = x;
        point.y = y;
        zoom = 0;
      }

      // get the id of the object at that location
      objid = getAnnoId(point, zoom);

      if (parseInt(objid) == 0) {
        return "No RAMON object here.";
      }

      // AB TODO set this based on the project
      var queryserver = "localhost";
      // string for return
      var objstr = 'ID: ' + objid;

      var script_name = '{{ request.META.SCRIPT_NAME }}';
      if (script_name == '') {
        var ramonUrl = "http://{{ request.get_host }}/ramoninfo/" + queryserver + "/" + ndv.querytoken + "/" + ndv.querychannel + "/" + objid + "/";
      }
      else {
        var ramonUrl = "http://{{ request.get_host }}/{{ request.META.SCRIPT_NAME }}/ramoninfo/" + queryserver + "/" + ndv.querytoken + "/" + ndv.querychannel + "/" + objid + "/";
      }

      // make request (using jquery)
      var jqxhr = $.ajax({
        url: ramonUrl,
        type: 'GET',
        success: function(response) {
          console.log(response);
          $( ".querybody" ).empty();
          $( ".querybody" ).append(response);
          $( ".queryres" ).show("slow");
          },
        })
        .fail(function(response) {
          console.log('failure');
          objstr = 'Failed to retrieve RAMON obj.';
        });
      console.log(objstr);
      return objstr;

    }

		// popup on click (querytool)
		var popup = L.popup();
		function onMapClick(e) {
      if (ndv.querytool) {
        var reqPoint = map.project(e.latlng);
        popup
          .setLatLng(e.latlng)
          .setContent( getRamonInfo(reqPoint, map.getMaxZoom() - ndv.upsample_num - map.getZoom()) )
          .openOn(map);
      }
		}
		map.on('click', onMapClick);

    // keyboard shortcuts
    $(document).keypress(function(event) {
      if ( !$(event.target).is('input')) {
        console.log(event.which);
        switch (event.which) {
          case 104: // h -- help
            toggleKeyboardHelp();
            break;
          case 119: // w -- ndv.zindex++
            incZIndex();
            break;
          case 115: // s -- ndv.zindex--
            decZIndex();
            break;
          case 97: // a -- zoom out
            map.zoomOut()
            break;
          case 100: // d -- zoom in
            map.zoomIn()
            break;
          default:
            // do nothing

        }
      }
    });
    function toggleKeyboardHelp() {
      if ($( ".keyhelp" ).css("display") == "none") {
        $( ".keyhelp" ).fadeIn( 1000, function() {
          // Animation complete
        });
      }
      else {
        $( ".keyhelp" ).fadeOut( 500, function() {
          // Animation complete
        });
      }
    }

    // tools
    // query tool

    // disable querying
    $( '#query_none' ).click(function(event) {
      if (ndv.querytool) {
        $( '#query_' + ndv.querylayer + '_check' ).css("visibility","hidden");
        $( '#query_none_check' ).css("visibility","");
        ndv.querytool = false;
        ndv.querylayer = 'none';
        ndv.querytoken = 'none';
        ndv.querychannel = 'none';
      }
    });

    {% for layer in layers %}
    {% if layer.layertype == 'annotation' %}
    $( '#query_{{ layer.token }}_{{ layer.channel }}' ).click(function(event) {
    //$( '#querybutton' ).toggleClass('active');
      var curlayer = "{{ layer.token }}_{{ layer.channel }}";
      if (ndv.querylayer != curlayer) {
        console.log('Updating ' + ndv.querylayer + ' to ' + curlayer);
        $( '#query_' + ndv.querylayer + '_check' ).css("visibility","hidden");
        $( '#query_{{ layer.token }}_{{ layer.channel }}_check' ).css("visibility","");
        ndv.querylayer = curlayer;
        ndv.querytoken = '{{ layer.token }}';
        ndv.querychannel = '{{ layer.channel }}';
        ndv.querytool = true;
      }
    });
    {% endif %}
    {% endfor %}

    // TODO clicking on a marker pops up coordinates

    // add keyboard help to map
		var keyhelp = L.control();
		keyhelp.options.position = 'bottomleft';
		keyhelp.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'keyhelp');
			this.update();
			return this._div;
		};

		keyhelp.update = function () {
      this._div.innerHTML =
      "<h5>Keyboard Shortcuts</h5><ul class='list-unstyled'>" +
        "<li><kbd>h</kbd> display help</li>" +
        "<li><kbd>w</kbd> increase z-index</li>" +
        "<li><kbd>a</kbd> zoom out</li>" +
        "<li><kbd>s</kbd> decrease z-index</li>" +
        "<li><kbd>d</kbd> zoom in</li>" +
        "</ul><small>Press <kbd>h</kbd> to close.</small>";
		};

    keyhelp.addTo(map);

    // blend mode
    $(function() {
      $('#blendmode').change(function(e) {
        var changed = $(e.target);

        if (changed.is('select[name="blendmode"]')) {
          for (layer in layers) {
            layers[layer].setBlendMode(changed.val());
          }
        }
      });
    }); // blend mode

    // play delay
    $(function() {
      $('.playdelay-submit').click(function(e) {
        var val = $('.playdelay-input').val();
        ndv.playdelay = val;
      });
    }); // play delay

    // remove a layer
    $(function() {
      $( "#image-sliders" ).on( "click", ".remove-layer", function() {
        console.log('click');
        var class_arr = this.className.split(' ');
        var layer_name = $.trim(class_arr[1]);
        console.log('Removing ' + layer_name);
        // remove layer from the map
        map.removeLayer( layers[layer_name] );
        // remove layer from control panel
        $( ".controls-" + layer_name ).remove();
      });
    });

    // close the queryinfo window
    $(function() {
      $( "#closequerybox" ).click(function() {
        $( ".queryres" ).hide( "slow" );
      });
    });


    // timeseries functions
    function loadTimeStep(newTime) {
      map.closePopup();
      if (newTime < {{ starttime }}) {
        $( "#timestep" ).parent().addClass("has-error");
      }
      else if (newTime > {{ endtime }}) {
        $( "#timestep" ).parent().addClass("has-error");
      }
      else {
        $( "#timestep" ).parent().removeClass("has-error");
        {% for layer in layers %}
        {% if layer.layertype == "timeseries" %}
          layers.{{ layer.layer_name|cut:" " }}.options.curtime = newTime;
          var newTimeStr = newTime.toString();
          {% if layer.tilecache %}
            var newUrl = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% else %}
          var newUrl = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
          layers.{{ layer.layer_name|cut:" " }}.setUrl(newUrl, true);
          layers.{{ layer.layer_name|cut:" " }}.smoothRedraw();
        {% endif %}
        {% endfor %}
      }
    }

    function timeStepForward() {
      map.closePopup();
      {% for layer in layers %}
      {% if layer.layertype == "timeseries" %}
        var curTime = parseInt(layers.{{ layer.layer_name|cut:" " }}.options.curtime);
        if (curTime + 1 <= parseInt({{ endtime }})) {
          $( "#timestep" ).parent().removeClass("has-error");
          var newTime = curTime + 1;
          layers.{{ layer.layer_name|cut:" " }}.options.curtime = newTime;
          var newTimeStr = newTime.toString();
          {% if layer.tilecache %}
            var newUrl = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% else %}
          var newUrl = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
          layers.{{ layer.layer_name|cut:" " }}.setUrl(newUrl, true);
          layers.{{ layer.layer_name|cut:" " }}.smoothRedraw();
        }
        else {
          $( "#timestep" ).parent().addClass("has-error");
        }
      {% endif %}
      {% endfor %}
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
		}

		function timeStepBack() {
      map.closePopup();
      {% for layer in layers %}
      {% if layer.layertype == "timeseries" %}
        var curTime = parseInt(layers.{{ layer.layer_name|cut:" " }}.options.curtime);
        if (curTime - 1 >= parseInt({{ starttime }})) {
          $( "#timestep" ).parent().removeClass("has-error");
          var newTime = curTime - 1;
          layers.{{ layer.layer_name|cut:" " }}.options.curtime = newTime;
          var newTimeStr = newTime.toString();
          {% if layer.tilecache %}
            var newUrl = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% else %}
          var newUrl = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
          layers.{{ layer.layer_name|cut:" " }}.setUrl(newUrl, true);
          layers.{{ layer.layer_name|cut:" " }}.smoothRedraw();
        }
        else {
          $( "#timestep" ).parent().addClass("has-error");
        }
      {% endif %}
      {% endfor %}
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
		}

    function timeBeginning() {
      map.closePopup();
      {% for layer in layers %}
      {% if layer.layertype == "timeseries" %}
        var newTimeStr = {{ starttime }};
        layers.{{ layer.layer_name|cut:" " }}.options.curtime = newTimeStr;
        {% if layer.tilecache %}
            var newUrl = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
        {% else %}
        var newUrl = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
        {% endif %}
        layers.{{ layer.layer_name|cut:" " }}.setUrl(newUrl, true);
        layers.{{ layer.layer_name|cut:" " }}.smoothRedraw();
      {% endif %}
      {% endfor %}
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
    }

    function timeEnd() {
      map.closePopup();
      {% for layer in layers %}
      {% if layer.layertype == "timeseries" %}
        var newTimeStr = {{ endtime }};
        layers.{{ layer.layer_name|cut:" " }}.options.curtime = newTimeStr;
        {% if layer.tilecache %}
            var newUrl = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% else %}
          var newUrl = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
          layers.{{ layer.layer_name|cut:" " }}.setUrl(newUrl, true);
          layers.{{ layer.layer_name|cut:" " }}.smoothRedraw();
      {% endif %}
      {% endfor %}
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
		}

    var play;
    $(function() {
      $( "#play" ).click(function() {
        play = setInterval(function() { timeStepForward(); }, 1000*ndv.playdelay); // 1 second default
      });
    });
    $(function() {
      $( "#pause" ).click(function() {
        clearTimeout(play);
      });
    });
    $(function() {
      $( "#beginning" ).click(function() {
        timeBeginning();
      });
    });
    $(function() {
      $( "#end" ).click(function() {
        timeEnd();
      });
    });
    $(function() {
      $( "#forward" ).click(function() {
        timeStepForward();
      });
    });
    $(function() {
      $( "#back" ).click(function() {
        timeStepBack();
      });
    });

  </script>
  {% if timeseries == True %}

  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="timeseries-control-box">
            <div id="timeseries-control-buttons">
              <a href="#" id="beginning"><i class="fa fa-lg fa-backward fa-border"></i></a>

              <a href="#" id="back"><i class="fa fa-lg fa-step-backward fa-border"></i></a>

              <a href="#" id="play"><i class="fa fa-lg fa-play fa-border"></i></a>

              <a href="#" id="pause"><i class="fa fa-lg fa-pause fa-border"></i></a>

              <a href="#" id="forward"><i class="fa fa-lg fa-step-forward fa-border"></i></a>

              <a href="#" id="end"><i class="fa fa-lg fa-forward fa-border"></i></a>
            </div>
            <div>
            <small>Play Delay (sec):</small>
            <input class="playdelay-input" type="number" step="any" min="0" max="100" value="1" />
              <a class="playdelay-submit" href="#"><i class="fa fa-clone fa-lg"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
  {% endif %}

  {# after generating the main UI, open dataview, etc #}
  {% if dataview %}
    <script>
      $(window).load(function() {
        $( '#displayDataview' ).modal('show');
      });
    </script>
  {% endif %}

</body>
{# jquery and bootstrap js #}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
{# jquery ui (for slider) #}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
{# jquery ui on mobile #}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
{# camanjs #}
<script type="text/javascript" src="{% static "ndv/js/caman.full.js" %}"></script>
</html>
