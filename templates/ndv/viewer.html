<!DOCTYPE html>
<html>
<!--
# Copyright 2016 NeuroData (http://neurodata.io)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Designed, Developed, and Maintained by Alex Baden
# abaden1@jhu.edu
# github.com/alexbaden

!-->
<head>
  <title>NeuroDataViz: viewing {{ project_name }}</title>
  {% load staticfiles %}
  {# boostrap files #}
  <link rel="stylesheet" type ="text/css" href="{% static 'bootstrap/css/bootstrap.css' %}" />

  {# jquery UI #}
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">

  {# leaflet files #}
  <link rel="stylesheet" href="{% static 'ndv/leaflet/leaflet.css' %}" />
  <link rel="stylesheet" href="{% static 'ndv/css/Control.Loading.css' %}" />

  {# buttons, buttons, buttons #}
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  {# css file #}
  <link rel="stylesheet" href="{% static 'ndv/css/viewer.css' %}" />

  {% if GOOGLE_ANALYTICS_PROPERTY_ID %}
    {% include "ndv/analytics.html" %}
  {% endif %}

  {# react #}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>

  {# react dev -- add ".min" before ".js" for production #}
  <script src="{% static 'ndv/js/react-with-addons.js' %}"></script>
  <script src="{% static 'ndv/js/react-dom.js' %}"></script>

  <script src="{% static 'ndv/leaflet/leaflet-src.js' %}"></script>
  {#<script src="{% static 'ndv/leaflet/leaflet.js' %}"></script>#}
  <script src="{% static 'ndv/js/Control.Loading.js' %}"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="{% static 'ndv/js/spin.min.js' %}"></script>
  <script src="{% static 'ndv/js/easy-button.js' %}"></script>
  <script src="{% static 'ndv/js/ocp-leaflet.js' %}"></script>
  {# threejs #}
  <script src="{% static 'ndv/js/threejs/three.min.js' %}"></script>

	</head>
<body>

  {# Begin Modal Code Includes #}
  {% include "ndv/help.html" %}

  {% include "ndv/nav.html" %}

  {% include "ndv/add_data.html" %}

  {% include "ndv/login.html" %}

  {% include "ndv/blendmodes.html" %}
  {# End Modal Code Includes #}

  <div id="map"></div>
  <script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  </script>

  <script id="fragmentShader" type="x-shader/x-fragment">
    varying vec2 vUv;

    uniform vec3 color;
    uniform sampler2D texture;

    uniform float opacity;

    // remapping
    uniform float minval;
    uniform float maxval;

    // gamma
    uniform float gamma;

    void main() {
      vec4 tmpColor;

      #ifdef REMAP
      tmpColor = texture2D(texture, vUv) * vec4(color.x, color.y, color.z, opacity);
      // remap color to new intensity range
      tmpColor.x = min( max( (tmpColor.x - minval)/maxval, 0.0), 1.0 );
      tmpColor.y = min( max( (tmpColor.y - minval)/maxval, 0.0), 1.0 );
      tmpColor.z = min( max( (tmpColor.z - minval)/maxval, 0.0), 1.0 );
      #else
      tmpColor = texture2D(texture, vUv) * vec4(color.x, color.y, color.z, opacity);
      #endif

      #ifdef GAMMACOR
      tmpColor.rgb = pow(tmpColor.rgb, vec3(1.0 / gamma));
      #endif

      gl_FragColor = tmpColor;

    }
  </script>
  <script>
    // AB TODO use strict

    // global variables
    var ndv = {};
    ndv.querytool = false;
    ndv.querytoken = 'none';
    ndv.querychannel = 'none';
    ndv.queryserver = 'none';

    // timeseries globals
    ndv.playdelay = 1;

    // marker array
    ndv.markers = [];

    // upsample settings
    ndv.upsample_num = 2;

    // dataset info
    ndv.xstart = {{ xstart }};
    ndv.xmin = {{ xoffset }};
    ndv.xmax = {{ xsize }} + {{ xoffset }} - 1;

    ndv.ystart = {{ ystart }};
    ndv.ymin = {{ yoffset }};
    ndv.ymax = {{ ysize }} + {{ yoffset }} - 1;

    ndv.zmin = {{ zoffset }};
    ndv.zmax = {{ zsize }} + {{ zoffset }} - 1;

    ndv.minres = {{ minres }};
    ndv.maxres = {{ maxres }};
    ndv.res = {{ res }};
    // set zindex to some default (we pick the lowest slice)
    ndv.zindex = {{ zstart }};

    // blend mode
    ndv.blendmode = THREE.NormalBlending;

     // create the map first
		var map = L.map('map', {
      crs: L.CRS.Simple,
			doubleClickZoom: false,
    });

    // add loading symbol
    var spinOpts = {
      lines: 13,
      length: 3,
      width: 3,
      radius: 5,
      rotate: 13,
      speed: 1.7,
      top: "83%",
    };
    var loadingControl = L.Control.loading({
      spinjs: true,
      spin: spinOpts
    });
    map.addControl(loadingControl);

    // define layers (namespaced with a layers. prefix)
    var layers = {};

    // add layer function
    function addLayer(layername, layertype, layerpropagate, url, server, token, channel, color, tilecache) {

      layers[layername] = {
        'tileLayer': null,
        'server': server,
        'token': token,
        'channel': channel,
        'type': layertype,
        'color': color,
        'opacity': 1.0,
        'min': 0.0,
        'max': 1.0,
        'gamma': 1.0,
        'blending': ndv.blendmode,
        'tilecache': tilecache,
      }

      var opacity;
      var propagate;

      if (layertype == 'annotation') {

        propagate = 2; // annotations propagation status doesn't matter
        opacity = 0.4; // annotations loaded at 40% opacity by default
        layers[layername].opacity = 0.4;
        layers[layername].blending = THREE.NormalBlending; // annotations have normal blending
      }
      else
      {
        opacity = 1.0;
        propagate = layerpropagate;
      }

      var curtime = 0;
      if (layertype == 'timeseries') {
        curtime = {{ starttime }};
      }

      layers[layername]['tileLayer'] = L.tileLayer.OCPLayer(
        url,
        {
          zindex: ndv.zindex,
          zoomReverse: true,
          minZoom: ndv.maxres,
          maxZoom: ndv.maxres + ndv.maxres + ndv.upsample_num,
          maxNativeZoom: ndv.maxres + ndv.maxres,
          tileSize: 512,
          opacity: opacity,
          propagate: propagate,
          curtime: curtime,
          continuousWorld: true,
        }
      );

      layers[layername].tileLayer.addTo(map);
    }

    function updateLayerUrl(layername, newUrl) {
      layers[layername].tileLayer.setUrl(newUrl);
      //layers[layername].tileLayer.smoothRedraw();
    }

    // load image layers first
    {% for layer in layers %}
      {% if layer.layertype != 'annotation' %}
      {# setup the URL #}

        {% if layer.channel %}
          var webtoken = '{{ layer.token }}/{{ layer.channel }}';
        {% else %}
          var webtoken = '{{ layer.token }}';
        {% endif %}

        {% if layer.tilecache %}
          {% if layer.layertype == 'timeseries' %}
            {% if layer.tilecache_server %}
              var url = 'http://{{ layer.tilecache_server }}/ocptilecache/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
            {% else %}
              var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
            {% endif %}
          {% else %}
            {% if layer.tilecache_server %}
            {# note: presently unclear what the tilecache URL endpoint should be #}
              var url = 'http://{{ layer.tilecache_server }}/ocptilecache/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
            {% else %}
              var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
            {% endif %}
          {% endif %}

        {% else %}
          {% if layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
        {% endif %}

        {# add the layer #}
        addLayer( "{{ layer.layer_name|cut:" " }}", "{{ layer.layertype }}",  "{{ layer.propagate }}", url, "{{ layer.server }}", "{{ layer.token }}", "{{ layer.channel }}", "{{ layer.color }}", {{ layer.tilecache|lower }});
        {% endif %}
    {% endfor %}

    // now load annotations
    {% for layer in layers %}
      {% if layer.layertype == 'annotation' %}
      {# setup the URL #}

        {% if layer.channel %}
          var webtoken = '{{ layer.token }}/{{ layer.channel }}';
          {% if layer.color %}
            webtoken = webtoken + ':{{layer.color}}';
          {% endif %}
        {% else %}
          var webtoken = '{{ layer.token }}';
        {% endif %}

        {% if layer.tilecache %}
          {% if layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocptilecache/tilecache/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}

        {% else %}
          {% if layer.color %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/mcfc/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% elif layer.layertype == 'timeseries' %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{{ starttime }}/{zindex}/{y}_{x}_{z}.png';
          {% else %}
            var url = 'http://{{ layer.server }}/ocp/catmaid/' + webtoken + '/xy/{zindex}/{y}_{x}_{z}.png';
          {% endif %}
        {% endif %}

        {# add the layer #}
        addLayer( "{{ layer.layer_name|cut:" " }}", "{{ layer.layertype }}", "{{ layer.propagate }}", url, "{{ layer.server }}", "{{ layer.token }}", "{{ layer.channel }}", "{{ layer.color }}", {{ layer.tilecache|lower }});
        {% endif %}
    {% endfor %}


    function setThreeColor(color) {
      // given a color tag ('r','g','b','c','m','y') set the appropriate three color
      switch(color) {
        case 'R':
          return new THREE.Color("rgb(255,0,0)");
        case 'G':
          return new THREE.Color("rgb(0, 255, 0)");
        case 'B':
          return new THREE.Color("rgb(0, 0, 255)");
        case 'C':
          return new THREE.Color("rgb(0, 255, 255)");
        case 'M':
          return new THREE.Color("rgb(255, 0, 255)");
        case 'Y':
          return new THREE.Color("rgb(255, 255, 0)");
        default:
          return new THREE.Color("rgb(255, 255, 255)");
      }
    }

    // add the webgl layer
    var glLayer = new L.WebGLLayer({
      zindex: ndv.zindex,
      zoomReverse: true,
      minZoom: ndv.maxres,
      maxZoom: ndv.maxres + ndv.maxres + ndv.upsample_num,
      maxNativeZoom: ndv.maxres + ndv.maxres,
      tileSize: 512,
    }).addTo(map);

    glLayer.draw = function() {

      // set layer to not idle so we actually render!
      this.isIdle = false;

      var scene = new THREE.Scene();

      var worldsize = this._map.getSize();
      var origin = this._map.getPixelOrigin();
      var shift = this._map.getPixelBounds().min.subtract(origin);
      var camera = this._camera;

      // get size from local function since layers may not have loaded
      var size = this._getTileSize();

      var vertexShader = document.getElementById('vertexShader').text;
      var fragmentShader = document.getElementById('fragmentShader').text;

      function loadTexture(img, layer, offsetx, offsety, color, opacity, minval, maxval, gamma, blending) {
        // use dom element for textures
        var texture = new THREE.Texture({
          repeat: 1,
        });

        texture.image = img;
        texture.name = layer;
        if ( $(img).hasClass('leaflet-tile-loaded') ) {
          texture.needsUpdate = true;
        } else {
          layer.on('tileload', function(e) {
            if (e.tile == texture.image) {
              texture.needsUpdate = true;
            }
          }, this);
        }

        var geometry = new THREE.PlaneBufferGeometry(size, size);

        // some default uniforms
        var uniforms = {
          color: { type: "c", value: color },
          texture: { type: "t", value: texture },
          opacity: { type: "f", value: opacity },
          minval: { type: "f", value: minval },
          maxval: { type: "f", value: maxval },
          gamma: { type: "f", value: gamma },
        };

        // TODO only enable these when sliders have been moved
        var defines = {
          REMAP: true,
          GAMMACOR: true,
        }

        var material = new THREE.ShaderMaterial({
          uniforms: uniforms,
          defines: defines,
          vertexShader: vertexShader,
          fragmentShader: fragmentShader,
          transparent: true,
          blending: blending,
        });

        var plane = new THREE.Mesh( geometry, material );

        // dispose of material, geometry, and mesh on unload
        layer.on('tileunload', function(e) {
          if (e.tile == texture.image) {
            texture.dispose();
            geometry.dispose();
            geometry = undefined;
            material.dispose();
            material = undefined;
            scene.remove(plane);
            plane = undefined;
          }
        }, this);

        // offset tile
        plane.position.set(offsetx, offsety, 0);

        scene.add(plane);
      }

      if (Object.keys(layers).length == 0) {
        return;
      }

      for (var layer in layers) {
        var color = setThreeColor(layers[layer].color);
        var opacity = layers[layer].opacity;
        var minval = layers[layer].min;
        var maxval = layers[layer].max;
        var gamma = layers[layer].gamma;
        var blending = parseInt(layers[layer].blending);

        for (var tile in layers[layer].tileLayer._tiles) {
          var img = layers[layer].tileLayer._tiles[tile];

          var offset = this._getTilePos(tile);

          loadTexture(img, layers[layer].tileLayer, offset.x, offset.y, color, opacity, minval, maxval, gamma, blending);
        }
      }

      this._camera.position.z = 1;

      this._renderTarget = new THREE.WebGLRenderTarget( worldsize.x, worldsize.y );

      function render() {
        if (this._repeater) {
          cancelAnimationFrame(this._repeater);
        }
        this._repeater = requestAnimationFrame( render.bind(this) );
        if (!glLayer.isIdle) {
          this._renderer.render(scene, this._camera, this._renderTarget);
          this._renderToScreen();
        }
      }
      render.bind(this)();
    }

    // cancel the render loop by setting the map to be idle every second
    $(function() {
      setInterval(function() { glLayer.isIdle = true; }, 5000); // set idle after 5 seconds
    })
    // cancel idle on user interaction
    map.on('viewreset', function() { glLayer.isIdle = false; });


    function coordinatesDebug(event) {
      // place a leaflet marker and a webgl marker at the click

      var point = map.project(event.latlng);
      var marker_options = {
        title: point.x + " " + point.y + " " + ndv.zindex,
      }

      // add leaflet marker
      L.marker(event.latlng, marker_options).addTo(map);

      var projPoint = map._getCenterOffset(event.latlng);
      // add GL marker
      glLayer._drawCircle( L.point([projPoint.x, -projPoint.y])  );
    };

    //map.on('click', coordinatesDebug);

    // set the initial view
    var center = map.unproject(L.point( ndv.xstart, ndv.ystart ), ndv.maxres + ndv.maxres - ndv.res);
		map.setView(center, ndv.maxres + ndv.maxres - ndv.res);

    // BEGIN propagate warning box
    var propwarn = L.control();
    propwarn.options.position = 'topright';
    propwarn.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'propwarnbox');
      this._div.innerHTML = '<div class="alert alert-danger" role="alert"><span class="glyphicon glyphicon-alert" aria-hidden="true"></span><span class="sr-only">Warning:</span> The following layers are not propagated: <strong><span class="notpropchanlist"></span></strong>.<br />Image data may be missing at some resolutions!';
      return this._div;
    };
    propwarn.addTo(map);

    function checkPropagate() {
      $( ".propwarnbox" ).hide();
      $( ".notpropchanlist" ).empty();
      for (layer in layers) {
        if (layers[layer].tileLayer.options.propagate != 2) {
          $( ".propwarnbox" ).show();
          if ($( ".notpropchanlist" ).text().length > 0)  {
            $( ".notpropchanlist" ).append(", ");
          }
          $( ".notpropchanlist" ).append(layer);
        }
      }
    }
    checkPropagate();

    // END propagate warning box

    // BEGIN query result palette
    var queryres = L.control();
    queryres.options.position = 'topright';
    queryres.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'queryres');
      var header = '<div class="closequery" style="float:right;"><a id="closequerybox" href="#"><i class="fa fa-times fa-lg"></a></i></div><h4>Query Result</h4>';
      var querybody = '<div class="querybody"></div>';
      this._div.innerHTML = header + querybody;
      return this._div;
    };
		queryres.addTo(map);

    // disable (and then re-enable) clicking on mouseover
    queryres.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    queryres.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });
    // END query result palette


    var projinfo = L.control();
    projinfo.options.position = 'topright';
    projinfo.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'projinfo');
      this._div.innerHTML = '';
      return this._div;
    };
    projinfo.addTo(map);

    </script>



    <script type="text/babel">
    /* Testing React */

    // don't render react code as template tags
    {% verbatim %}

    /* Project Info Toolbox Components */
    var ProjectInfoController = React.createClass({
      getInitialState: function() {
        return {
          projinfo: null
        };
      },
      componentDidMount: function() {
        var url = "http://" + this.props.server + "/ocp/ca/" + this.props.token + "/info/";
        this.serverRequest = $.get(
          url,
          function( result ) {
            var projinfo = result;
            this.setState({
              projinfo: projinfo,
            });
          }.bind(this),
          'json'
        )
      },
      componentWillUnmount: function() {
        this.serverRequest.abort();
      },
      render: function() {
        return (
          <div>
            {(this.state.projinfo != null) ? <ProjectInfoDisplay projinfo={this.state.projinfo} /> : null}

          </div>
        );
      }
    });

    var ProjectInfoDisplay = React.createClass({
      render: function() {
        var project = this.props.projinfo.project;
        var channels = this.props.projinfo.channels;
        var dataset = this.props.projinfo.dataset;
        var metadata = this.props.projinfo.metadata;

        return (
          <div>
            <h4>{project.name}</h4>
            <p>{project.description}</p>
            <h5>Channels</h5>
            <table className="table table-condensed">
            <tbody>
              {Object.keys(channels).map(function(key, i) {
                return (
                  <tr key={i}>
                    <td><a href="#"
                      ref={function(a) {
                        var popoverHTML = "<strong>" + channels[key].description + "</strong>";
                        $(a).popover({content: popoverHTML, placement: "bottom", html: true, trigger: "focus"});
                      }.bind(this)}
                      >{key}</a></td>
                    <td><em>{channels[key].channel_type} ({channels[key].datatype})</em></td>
                  </tr>
                );
              })}
            </tbody>
            </table>
            <h5>Dataset</h5>
            <table className="table table-condensed">
            <tbody>
              <tr>
                <td colSpan="3"><strong>Image Size</strong></td>
              </tr>
              <tr>
                <td>x</td>
                <td>{dataset.offset[0][0]}</td>
                <td>{dataset.imagesize[0][0]}</td>
              </tr>
              <tr>
                <td>y</td>
                <td>{dataset.offset[0][1]}</td>
                <td>{dataset.imagesize[0][1]}</td>
              </tr>
              <tr>
                <td>z</td>
                <td>{dataset.offset[0][2]}</td>
                <td>{dataset.imagesize[0][2]}</td>
              </tr>
              <tr>
                <td colSpan="2"><strong>Low Resolution</strong></td>
                <td>{dataset.resolutions[dataset.resolutions.length - 1]}</td>
              </tr>
              <tr>
                <td><strong>Time Range</strong></td>
                <td>{dataset.timerange[0]}</td>
                <td>{dataset.timerange[1]}</td>
              </tr>
            </tbody>
            </table>
          </div>
        );
      }
    });

    /* Generic Toolbox Components */
    var ReactCSSTransitionGroup = React.addons.CSSTransitionGroup;

    var ToolboxShowIcon = React.createClass({
      render: function() {
        var iconClassString = "fa fa-stack-1x " + this.props.iconClassName;

        return (
          <div className="showToolboxIcon" style={{float: "left"}}>
            <span className="fa-stack fa-2x">
              <a href="#" onClick={this.props.onClick}>
                <i className="fa fa-square fa-stack-2x fa-inverse"></i>
                <i className={iconClassString}></i>
              </a>
            </span>
          </div>
        );
      }
    });

    var ToolboxHideIcon = React.createClass({
      render: function() {
        return (
          <div style={{float: 'right'}}>
            <a href="#" onClick={this.props.onClick}>
              <i className="fa fa-times fa-lg"></i>
            </a>
          </div>
        );
      }
    })

    var Toolbox = React.createClass({
      render: function() {
        var iconClassString = "fa fa-stack-1x " + this.props.iconClassName;
        return (
          <div className="toolbox">
            <ToolboxHideIcon onClick={this.props.onClick} />
            <div id="controlpanelheader">
              <div style={{float:"left"}}>
                <span className="fa-stack fa-2x" style={{paddingBottom: 5 + "px"}}>
                  <i className="fa fa-square fa-stack-2x fa-inverse"></i>
                  <i className={iconClassString}></i>
                </span>
              </div>
              <div className="headertext">{this.props.toolboxName}</div>
            </div>
            <div>
              {this.props.toolboxComponent}
            </div>
          </div>
        );
      }
    });

    var ToolboxController = React.createClass({
      getInitialState: function() {
        return {
          showToolbox: false,
        };
      },

      handleClick: function() {
        this.setState({ showToolbox: !this.state.showToolbox });
      },

      render: function() {
        var toolboxComponent = <ProjectInfoController token="kharris15apical" server="brainviz1.cs.jhu.edu" />;
        return (
          <div>
            { /* Transition group for the toolbox icon */ }
            <ReactCSSTransitionGroup transitionName="toolboxIconAnimate" transitionEnterTimeout={1} transitionLeaveTimeout={1} >
              { this.state.showToolbox
                ?
                null
                :
                <ToolboxShowIcon
                  iconClassName="fa-info"
                  onClick={this.handleClick}
                  key="showToolboxIcon"
                  /> }
            </ReactCSSTransitionGroup>

            { /* Transition group for the toolbox */ }
            <ReactCSSTransitionGroup transitionName="showToolbox" transitionEnterTimeout={500} transitionLeaveTimeout={1} component="div">
              { this.state.showToolbox
                ?
                <Toolbox
                  iconClassName="fa-info"
                  toolboxName="Project Info"
                  toolboxComponent = {toolboxComponent}
                  onClick={this.handleClick}
                  key="showToolbox" />
                :
                null }
            </ReactCSSTransitionGroup>
          </div>
        );
      }
    });

    ReactDOM.render( <ToolboxController iconClass="fa-info" />, document.getElementsByClassName('projinfo')[0]);

    {% endverbatim %}

    </script>
    <script>

    /* Commenting out for now...

    // BEGIN image control palette
    var imagecontrols = L.control();
    imagecontrols.options.position = 'topright';
    imagecontrols.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'imagecontrols');
      var showicon = '<div id="imagecontrolsshow" style="float:left;"><a id="showimagecontrols" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-picture-o fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="imagecontrolshide" style="display:none;">';
      var title = '<div style="float:right;"><a id="hideimagecontrols" href="#"><i class="fa fa-times fa-lg"></a></i></div><div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-picture-o fa-stack-1x"></i></span></div><div class="headertext">Image Controls</div></div>';

      var imgsliderdiv = '<div id="image-sliders"></div>'

      var blendmode = '<br /><div id="blendmode">Blending: <select name="blendmode"><option value="1">Normal</option><option value="2">Additive</option><option value="3">Subtractive</option><option value="4">Multiply</option><option value="0">None</option></select><span style="float: right;"><a href="#" data-toggle="modal" data-target="#blendModeHelp"><i class="fa fa-info-circle fa-lg"></i></a></span></div>';

      var hiddendivend = '</div>';

      this._div.innerHTML = showicon + hiddendivstart + title + imgsliderdiv + blendmode + hiddendivend;
      return this._div;
    };
    imagecontrols.addTo(map);
    // update sliders (removes all layers and adds from layers var)
    function updateImageControlSliders() {
      $( "#image-sliders" ).empty();
      for (layer in layers) {
        var tmphtml = '<div class="controls-' + layer + '"><div class="controls-layer-name"><a href="#" class="remove-layer ' + layer + '"><i class="fa fa-times-circle"></i></a><a href="#">' + layer + '</a></div><div class="controls-slider-name">Opacity</div><div id="slider"><span class="opacity">' + layer + '</span></div><br /><div class="controls-slider-name">Min</div><div id="slider"><span class="minslider">' + layer + '</span></div><br /><div class="controls-slider-name">Max</div><div id="slider"><span class="maxslider">' + layer + '</span></div><br /><div class="controls-slider-name">Gamma</div><div id="slider"><span class="gammaslider">' + layer + '</span></div><br /><div id="' + layer + '" class="colorbox"><div class="controls-slider-name">Color</div><div class="btn-group btn-group-xs"><button class="btn btn-default btn-color btn-r" value="R">R</button><button class="btn btn-default btn-color btn-g " value="G">G</button><button class="btn btn-default btn-color btn-b" value="B">B</button><button class="btn btn-default btn-color btn-c" value="C">C</button><button class="btn btn-default btn-color btn-m" value="M">M</button><button class="btn btn-default btn-color btn-y" value="Y">Y</button><button class="btn btn-default btn-color" value=""><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button></div></div><br /> </div>';
        $( "#image-sliders" ).append(tmphtml);
      }
      // min controls
      $(function() {
        $( "#slider > .minslider" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 255,
            value: 0,
            slide: function ( event, ui ) {
              layers[layer].min = ui.value/255.0;
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); glLayer.draw(); },
          });
        });
      });// end min controls
      // max controls
      $(function() {
        $( "#slider > .maxslider" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 255,
            value: 255,
            slide: function ( event, ui ) {
              layers[layer].max = ui.value/255.0;
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); glLayer.draw(); },
          });
        });
      });// end max controls
      // gamma controls
      $(function() {
        $( "#slider > .gammaslider" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 2,
            value: 1,
            step: 0.1,
            slide: function ( event, ui ) {
              layers[layer].gamma = ui.value;
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); glLayer.draw(); },
          });
        });
      });// end gamma controls
      // opacity controls
      $(function() {
        $( "#slider > .opacity" ).each(function() {
          var layer = $( this ).text();
          $( this ).empty().slider({
            min: 0,
            max: 100,
            value: layers[layer].opacity*100,
            slide: function ( event, ui ) {
                layers[layer].opacity = ui.value/100;
              },
            start: function ( event, ui ) { map.dragging.disable(); },
            stop: function ( event, ui ) { map.dragging.enable(); glLayer.draw(); },
          });
        });
      });// end opacity controls
      // color controls
      $(function () {
        $( ".colorbox" ).each( function() {
          var layer = $( this ).attr('id');
          // show current color
          $( this ).children('.btn-group').children( '.btn' ).each(function() {
            $( this ).click(function() {
              layers[layer].color = $(this).val();
              glLayer.draw();
            });
          });
        });
      });
      // end color controls
    };
    updateImageControlSliders();
    // toggle image controls
    $( "#showimagecontrols" ).on('click', function () {
      $( "#imagecontrolshide" ).toggle( "slow" );
      $( "#imagecontrolsshow" ).toggle();
    });
    $( "#hideimagecontrols" ).on('click', function () {
      $( "#imagecontrolshide" ).toggle( "slow", function () {
        $( "#imagecontrolsshow" ).toggle( );
      });
    });
    // disable (and then re-enable) clicking on mouseover
    imagecontrols.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
      map.scrollWheelZoom.disable();
    });

    imagecontrols.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
      map.scrollWheelZoom.enable();
    });
    // END image control palette

    // BEGIN projection service palette

    var projectModeButton = L.control();
    projectModeButton.options.position = 'topright';
    projectModeButton.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'projectMode');
      var showicon = '<div id="projectModeIcon" style="float:left;"><a id="showProjectModeBox" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-sort-amount-asc fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="projectModeBox" style="display:none;">';
      var title = '<div style="float:right;"><a id="hideProjectModeBox" href="#"><i class="fa fa-times fa-lg"></a></i></div><div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-sort-amount-asc fa-stack-1x"></i></span></div><div class="headertext">Projection View</div></div>';
      var width = '<br /><div id="projectModeWidth">Width: <input id="projectModeWidthInput" type="number" min="0" max="50" value="5" /></div>';
      //var type = '<br /><div id="projectModeType">Type: <select id="projectModeTypeInput"><option value="max">Max Projection</option><option value="min">Min Projection</option></select></div>';
      var apply = '<br /><button class="btn btn-primary" id="projectModeApply" >Load Projection</button>'
      var hiddendivend = '</div>'
      this._div.innerHTML = showicon + hiddendivstart + title  + width + apply + hiddendivend;
      return this._div;
    };
    projectModeButton.addTo(map);
    $( "#showProjectModeBox" ).on('click', function () {
      $( "#projectModeBox" ).toggle( "slow", function () {
        $( "#projectModeIcon" ).toggle( );
      });
    });
    $( "#hideProjectModeBox" ).on('click', function () {
      $( "#projectModeBox" ).toggle( "slow" , function () {
        $( "#projectModeIcon" ).toggle( );
      });
    });
    // disable (and then re-enable) clicking on mouseover
    projectModeButton.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    projectModeButton.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });

    $( "#projectModeApply" ).click( function() {
      var width = $( "#projectModeWidthInput" ).val();

      for (var layername in layers) {
        var url = 'http://' + layers[layername].server + '/nd/catmaid/maxproj/' + layers[layername].token + '/' + layers[layername].channel + '/width:' + width + '/xy/{zindex}/{y}_{x}_{z}.png';
        updateLayerUrl( layername, url )
      }

      glLayer.draw();
    });

    // END projection service palette

    // BEGIN synaptogram service palette

    var synaptogramMode = L.control();
    synaptogramMode.options.position = 'topright';
    synaptogramMode.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'synaptogramMode');
      var showicon = '<div id="synaptogramModeIcon" style="float:left;"><a id="showSynaptogramModeBox" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-cubes fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="synaptogramModeBox" style="display:none;">';
      var title = '<div style="float:right;"><a id="hideSynaptogramModeBox" href="#"><i class="fa fa-times fa-lg"></a></i></div><div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-cubes fa-stack-1x"></i></span></div><div class="headertext">Synaptogram</div></div>';
      var x = '<br /><div id="synaptogramXInput">x: <input id="synaptogramX" type="number" min="0" value="0" /></div>';
      var y = '<br /><div id="synaptogramYInput">y: <input id="synaptogramY" type="number" min="0" value="0" /></div>';
      var z = '<br /><div id="synaptogramZInput">z: <input id="synaptogramZ" type="number" min="0" value="0" /></div>';
      var res = '<br /><div id="synaptogramResInput">res: <input id="synaptogramRes" type="number" min="0" value="0" /></div>';
      // AB TODO -- res won't work below res 0
      var apply = '<br /><button class="btn btn-primary" id="loadSynaptogram" >Load Synaptogram</button>'
      var hiddendivend = '</div>'
      this._div.innerHTML = showicon + hiddendivstart + title  + x + y + z + res + apply + hiddendivend;
      return this._div;
    };
    synaptogramMode.addTo(map);
    $( "#showSynaptogramModeBox" ).on('click', function () {
      $( "#synaptogramModeBox" ).toggle( "slow", function () {
        $( "#synaptogramModeIcon" ).toggle( );
      });
    });
    $( "#hideSynaptogramModeBox" ).on('click', function () {
      $( "#synaptogramModeBox" ).toggle( "slow" , function () {
        $( "#synaptogramModeIcon" ).toggle( );
      });
    });
    // disable (and then re-enable) clicking on mouseover
    synaptogramMode.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    synaptogramMode.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });

    // update coordinates on click
    map.on('click', function(event) {
      // get current res
      var res = map.getMaxZoom() - ndv.upsample_num - map.getZoom();
      $( "#synaptogramRes" ).val(res);

      // project latlng
      var coordinates = map.project(event.latlng);


      $( "#synaptogramX" ).val(Math.round(coordinates.x));
      $( "#synaptogramY" ).val(Math.round(coordinates.y));
      $( "#synaptogramZ" ).val(ndv.zindex);

    });

    $( "#loadSynaptogram" ).click( function() {
      var strWindowFeatures = "menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes";

      var x = $( "#synaptogramX" ).val();
      var y = $( "#synaptogramY" ).val();
      var z = $( "#synaptogramZ" ).val();
      var res = $( "#synaptogramRes" ).val();

      var channels = []
      for (layer in layers) {
        channels.push(layers[layer].channel);
      }
      var chanstr = channels.join(',');

      var token = '{{ layers.0.token }}' // AB TODO allow user to choose if multiple?
      var server = '{{ layers.0.server }}'

      window.open('http://{{ request.get_host }}{{ request.META.SCRIPT_NAME }}/tools/synaptogram/' + server + '/' + token + '/' + chanstr + '/' + res + '/' + x + ',5/' + y + ',5/' + z + ',7/', "Synaptogram", strWindowFeatures);

    });

    /*
    $( "#projectModeApply" ).click( function() {
      var width = $( "#projectModeWidthInput" ).val();

      for (var layername in layers) {
        if (layers[layername].color == '') {
          var url = 'http://' + layers[layername].server + '/nd/catmaid/maxproj/' + layers[layername].token + '/' + layers[layername].channel + '/width:' + width + '/xy/{zindex}/{y}_{x}_{z}.png';
        }
        else {
          var url = 'http://' + layers[layername].server + '/nd/catmaid/maxproj/' + layers[layername].token + '/' + layers[layername].channel + ':' + layers[layername].color + '/width:' + width + '/xy/{zindex}/{y}_{x}_{z}.png';
        }
        updateLayerUrl( layername, url )
      }
    });

    // END synaptogram service palette

    // BEGIN query tool palette
    var queryToolControl = L.control();
    queryToolControl.options.position = 'topright';
    queryToolControl.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'queryToolControl');
      var showicon = '<div id="queryToolControlIcon" style="float: left;"><a id="showQueryToolBox" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-search fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="queryToolBox" style="display:none;">';

      var title = '<div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-search fa-stack-1x"></i></span></div><div class="headertext">Query Tool</div></div>';

      var formdiv = '<div id="queryToolForm">';

      var endformdiv = '</div>';

      var hiddendivend = '</div>'

      this._div.innerHTML = showicon + hiddendivstart + title + formdiv + endformdiv + hiddendivend;
      return this._div;
    };
		queryToolControl.addTo(map);

    var updateQueryToolOptions = function() {
      $( "#queryToolForm").empty();

      // use the form class to get bootstrap formatting
      var formstart = '<form><div class="form-group"><select class="form-control" id="queryLayerSelect">';

      var layerDropdown = '<option value="none" selected>None</option>';
      for (layer in layers) {
        if (layers[layer].type == 'annotation') {
          var newOpt =  '<option value="' + layer + '">' + layer + '</option>';
          layerDropdown += newOpt;
        }
      }

      var formend = '</select></div></form>';

      $( "#queryToolForm" ).html(formstart + layerDropdown + formend);
    }
    updateQueryToolOptions();

    $(function() {
      $( "#queryLayerSelect" ).change(function(e) {
        var changed = $(e.target).val();
        if (changed == 'none') {
          // disable query tool
          ndv.querytool = false;
          ndv.querytoken = 'none';
          ndv.querychannel = 'none';
          ndv.queryserver = 'none';
          return;
        }
        ndv.querytoken = layers[changed].token;
        ndv.querychannel = layers[changed].channel;
        ndv.queryserver = layers[changed].server;
        ndv.querytool = true;
      });
    })



    // disable (and then re-enable) clicking on mouseover
    queryToolControl.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
      $( "#queryToolBox" ).show();
      $( "#queryToolControlIcon" ).hide();
    });

    queryToolControl.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
      $( "#queryToolControlIcon" ).show();
      $( "#queryToolBox" ).hide();
    });

    // END query tool palette

    // BEGIN marker tool palette
    var markerToolControl = L.control();
    markerToolControl.options.position = 'topright';
    markerToolControl.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'markerToolControl');

      var showicon = '<div id="markerToolControlIcon" style="float: left;"><a id="showMarkerControlBox" href="#"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-map-marker fa-stack-1x"></i></span></a></div>';

      var hiddendivstart = '<div id="markerToolBox" style="display:none;">';

      var title = '<div id="controlpanelheader"><div style="float:left;"><span class="fa-stack fa-2x" style="padding-bottom: 5px;"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-map-marker fa-stack-1x"></i></span></div><div class="headertext">Markers</div></div>';

      var click = '<div class="form-group"><button id="markerModeClick" class="btn btn-primary btn-block">On Click</button></div>';

      var center = '<div class="form-group"><button id="markerModeCenter" class="btn btn-primary btn-block">Center</button></div>';

      var clear = '<div class="form-group"><button id="clearmarkers" class="btn btn-danger btn-block">Clear Markers</button></div>';

      var hiddendivend = '</div>'

      this._div.innerHTML = showicon + hiddendivstart + title + click + center + clear + hiddendivend;
      return this._div;
    };
    markerToolControl.addTo(map);

    // disable (and then re-enable) clicking on mouseover
    markerToolControl.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
      $( "#markerToolBox" ).show();
      $( "#markerToolControlIcon" ).hide();
    });

    markerToolControl.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
      $( "#markerToolBox" ).hide();
      $( "#markerToolControlIcon" ).show();
    });

    // marker controls
    var enableMarkerOnClick = function() {
      map.on('click', markerOnClick);
      // turn off query tool
      map.off('click', onMapClick);
    }

    // button actions
    $( "#markerModeClick" ).on('click', function() {
      if ( $( "#markerModeClick").hasClass('btn-primary') ) {
        // enable marker tool on click
        //map.on('click', markerOnClick);
        setTimeout(enableMarkerOnClick, 300);
        // change button
        $( "#markerModeClick" ).removeClass('btn-primary');
        $( "#markerModeClick" ).addClass('btn-success');
      }
      else {
        // disable marker tool on click
        map.off('click', markerOnClick);
        // change button
        $( "#markerModeClick" ).removeClass('btn-success');
        $( "#markerModeClick" ).addClass('btn-primary');
      }
    });

    $( "#markerModeCenter" ).on('click', function() {
      addMarkerCenter();
    });
    $( "#clearmarkers" ).click(function( event ) {
      var index;
      for (index = 0; index < ndv.markers.length; index++) {
        map.removeLayer(ndv.markers[index]);
      }
    });
    //end button actions

    var addMarkerCenter = function() {
      // place a marker at the current map center
      var center = map.getCenter();
      var point = map.project(center);
      var marker_options = {
        title: point.x + " " + point.y + " " + ndv.zindex,
      }

      // keep track of markers by storing in an array
      ndv.markers.push(L.marker(center, marker_options).addTo(map));

      // get current url
      var markerUrl = getCurrentURL(point);

      var popup_options = {
        maxWidth: 750,
      }

      ndv.markers[ndv.markers.length - 1].bindPopup('<a href="' + markerUrl + '">' + markerUrl + '</a>', popup_options);
    }
    {% if marker == True %}
      // add a marker to the center on page load
      addMarkerCenter();
    {% endif %}

    function markerOnClick(event) {
      // place a marker at the click

      var point = map.project(event.latlng);
      var marker_options = {
        title: point.x + " " + point.y + " " + ndv.zindex,
      }

      // keep track of markers by storing in an array
      ndv.markers.push(L.marker(event.latlng, marker_options).addTo(map));

      // get current url
      var markerUrl = getCurrentURL(point);
      var popup_options = {
        maxWidth: 750,
      }

      ndv.markers[ndv.markers.length - 1].bindPopup('<a href="' + markerUrl + '">' + markerUrl + '</a>', popup_options);

      // markerOnClick causes lots of problems with controls, so only one marker per click!
      map.off('click', markerOnClick);
      // change button
      $( "#markerModeClick" ).removeClass('btn-success');
      $( "#markerModeClick" ).addClass('btn-primary');
      // turn query tool back on
      setTimeout(reEnableQueryTool, 300);
    };

    var reEnableQueryTool = function() {
      map.on('click', onMapClick);
    }

    */

    function getCurrentURL(point) {
      var script_name = '{{ request.META.SCRIPT_NAME }}';
      var pathRaw = '{{ request.path }}';
      var pathArr = pathRaw.split('/');
      var curZoom = map.getMaxZoom() - ndv.upsample_num - map.getZoom();

      if (script_name == '') {
        var token = pathArr[1];
        var channels = '';
        // handle the case where we are in project view mode
        if (token == 'project') {
          token = 'project/' + pathArr[2];
          channels = '';
        }
        else {
          if (pathArr.length > 3 && !(pathArr[2] == 'xy' || pathArr[2] == 'yz' || pathRaw[2] == 'xz')) {
            channels = pathArr[2];
          }
        }

        if (channels == '') {
          var markerUrl = "http://{{ request.get_host }}/" + token + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
        else {
          var markerUrl = "http://{{ request.get_host }}/" + token + "/" + channels + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
      }
      else {
        var token = pathArr[2];
        var channels = '';
        // handle the case where we are in project view mode
        if (token == 'project') {
          token = 'project/' + pathArr[3];
          channels = '';
        }
        else {
          if (pathArr.length > 3 && !(pathArr[3] == 'xy' || pathArr[3] == 'yz' || pathRaw[3] == 'xz')) {
            channels = pathArr[3];
          }
        }

        if (channels == '') {
          var markerUrl = "http://{{ request.get_host }}" + script_name + "/" + token + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
        else {
          var markerUrl = "http://{{ request.get_host }}" + script_name + "/" + token + "/" + channels + "/xy/" +  curZoom + "/" + Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
        }
      }
      return markerUrl;
    };

    // END marker tool palette

    // BEGIN add data button
    var addDataButton = L.control();
    addDataButton.options.position = 'topright';
    addDataButton.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'addDataButton');
      var button = '<a id="add_data_link" href="#" data-toggle="modal" data-target="#add_data"><span class="fa-stack fa-2x"><i class="fa fa-square fa-stack-2x fa-inverse"></i><i class="fa fa-plus fa-stack-1x"></i></span></a>';
      this._div.innerHTML = button;
      return this._div;
    };
		addDataButton.addTo(map);

    // disable (and then re-enable) clicking on mouseover
    addDataButton.getContainer().addEventListener('mouseover', function() {
      map.off('click', onMapClick);
    });

    addDataButton.getContainer().addEventListener('mouseout', function() {
      map.on('click', onMapClick);
    });

    // END add data button palette

    // update current coordinates in nav box
    function coordinatesUpdate() {
      $( "#x" ).parent().removeClass("has-error");
      $( "#y" ).parent().removeClass("has-error");
      $( "#z" ).parent().removeClass("has-error");
      var center = map.getCenter();
      var res = map.getMaxZoom() - ndv.upsample_num - map.getZoom();
      var coordinates = map.project(center);

      $( "#x" ).val(Math.round(coordinates.x));
      $( "#y" ).val(Math.round(coordinates.y));
      $( "#z" ).val(ndv.zindex);
    };
    coordinatesUpdate();
    // update coordinates on pan, zoom, and load
    map.on('drag', coordinatesUpdate);
    map.on('zoomend', coordinatesUpdate);

    function resolutionBoxInit() {
      $( "#res-input" ).val(ndv.res);
    }
    resolutionBoxInit();

    function resolutionUpdate() {
      $( "#res-input" ).val( map.getMaxZoom() - ndv.upsample_num - map.getZoom() );
    }
    map.on('zoomend', resolutionUpdate);

    $( "#res-input" ).on('input', function() {
      var val = $( "#res-input" ).val();
      // ignore when the user deletes the contents of the box
      if (val == '') {
        return;
      }
      $( "#res-input" ).parent().removeClass("has-error");

      if (val < (ndv.minres - ndv.upsample_num) || val > ndv.maxres) {
        $( "#res-input" ).parent().addClass("has-error");
      }
      else {
        map.setZoom( map.getMaxZoom() - ndv.upsample_num - val );
      }
    });

    // navigation
    // first, intercept the form
    $( "#navigate" ).submit(function( event ) {
      event.preventDefault();
      // clear errors
      $( "#x" ).parent().removeClass("has-error");
      $( "#y" ).parent().removeClass("has-error");
      $( "#z" ).parent().removeClass("has-error");

      // if a valid (x,y) pair was entered, pan and place a marker
      // note, need to pan before changing slices
      if ( $( "#x" ).val() && $( "#y" ).val()) {
        var x = $( "#x" ).val();
        var y = $( "#y" ).val();

        // validate
        if ( x > ndv.xmax || x < ndv.xmin ) {
          $( "#x" ).parent().addClass("has-error");
        }
        else if ( y > ndv.ymax || y < ndv.ymin ) {
          $( "#y" ).parent().addClass("has-error");
        }
        else {
          // pan the map to center on these coordinates
          var point = L.point(x, y);
          var projpoint = map.unproject(point);

          map.panTo(projpoint);
          // place a marker
          //L.marker(projpoint).addTo(map);
        }
      }
      else {
        if ( $( "#x" ).val() && !$( "#y" ).val() ) {
          $( "#y" ).parent().addClass("has-error");
        }
        else if ( $( "#y" ).val() && !$( "#x" ).val() ) {
          $( "#x" ).parent().addClass("has-error");
        }
      }
      // if a zindex was entered, navigate to that slice
      if ( $( "#z" ).val() ) {
        var z = $( "#z" ).val();
        if (z <= ndv.zmax && z >= ndv.zmin) {
          chgZIndex(z);
        }
        else {
          $( "#z" ).parent().addClass("has-error");
        }
      }

      // handle timestep if timeseries
      {% if timeseries == True %}
        loadTimeStep( $( "#timestep" ).val() );
      {% endif %}
    });

		// z-index arrows
		L.easyButton('fa-arrow-up',
				incZIndex,
				'Increase Z-Index'
		);
		L.easyButton('fa-arrow-down',
				decZIndex,
				'Decrease Z-Index'
		);

    function chgZIndex(newz) {
      map.closePopup();
      var oldzindex = ndv.zindex;
			ndv.zindex = parseInt(newz);
			reloadLayers(oldzindex);
    }

		function incZIndex() {
      map.closePopup();
      var oldzindex = ndv.zindex;
      if ((ndv.zindex + 1) > ndv.zmax) {
        $( "#z" ).parent().addClass("has-error");
      }
      else {
        $( "#z" ).parent().removeClass("has-error");
        ndv.zindex = ndv.zindex + 1;
        reloadLayers(oldzindex);
      }
		}

		function decZIndex() {
      map.closePopup();
      var oldzindex = ndv.zindex;
      if ((ndv.zindex - 1) < ndv.zmin) {
        $( "#z" ).parent().addClass("has-error");
      }
      else {
        $( "#z" ).parent().removeClass("has-error");
        ndv.zindex = ndv.zindex - 1;
        reloadLayers(oldzindex);
      }
    }

		function reloadLayers() {
			map.options.fadeAnimation = false;
      glLayer.disableScreenRender();
      map.eachLayer( function (layer) {
        if ( layer.hasOwnProperty('_url') ) {
          layer.options.zindex = ndv.zindex;
					layer.smoothRedraw();
        }
      });
      map.options.fadeAnimation = true;
      glLayer.draw();
      setTimeout(glLayer.enableScreenRender.bind(glLayer), 300);
      glLayer.isIdle = false; // enable render loop
      coordinatesUpdate();
		}

		// get anno id from coordinate
    // expects a L.point object for point and a number for zoom
		function getAnnoId(point, zoom) {
      var script_name = '{{ request.META.SCRIPT_NAME }}';
      if (script_name == '') {
        var ocpUrlBase = "http://{{ request.get_host }}/query/" + ndv.queryserver + "/ca/" + ndv.querytoken + "/" + ndv.querychannel + "/id/" + zoom + "/";
      }
      else {
        var ocpUrlBase = "http://{{ request.get_host }}/{{ request.META.SCRIPT_NAME }}/query/" + ndv.queryserver + "/ca/" + ndv.querytoken + "/" + ndv.querychannel + "/id/" + zoom + "/";
      }
			var cutout = Math.round(point.x) + "/" + Math.round(point.y) + "/" + ndv.zindex + "/";
			var ocpUrl = ocpUrlBase.concat(cutout);

      // make request
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open( "GET", ocpUrl, false );
			xmlHttp.send( null );

			return xmlHttp.responseText;
		}

    function getRamonInfo(point, zoom) {
      // first, make sure that either zoom > 0 or
      // resample point and zoom to be at level 0
      if (zoom < 0) {
        var numScales = 0 - zoom;
        // scale the x and y coordinates of the point
        var x = Math.round( point.x / ( 2 * numScales ) );
        var y = Math.round( point.y / ( 2 * numScales ) );
        point.x = x;
        point.y = y;
        zoom = 0;
      }

      // get the id of the object at that location
      objid = getAnnoId(point, zoom);

      if (parseInt(objid) == 0) {
        return "No RAMON object here.";
      }

      // string for return
      var objstr = 'ID: ' + objid;

      var script_name = '{{ request.META.SCRIPT_NAME }}';
      if (script_name == '') {
        var ramonUrl = "http://{{ request.get_host }}/ramoninfo/" + ndv.queryserver + "/" + ndv.querytoken + "/" + ndv.querychannel + "/" + objid + "/";
      }
      else {
        var ramonUrl = "http://{{ request.get_host }}/{{ request.META.SCRIPT_NAME }}/ramoninfo/" + ndv.queryserver + "/" + ndv.querytoken + "/" + ndv.querychannel + "/" + objid + "/";
      }

      // make request (using jquery)
      var jqxhr = $.ajax({
        url: ramonUrl,
        type: 'GET',
        success: function(response) {
          $( ".querybody" ).empty();
          $( ".querybody" ).append(response);
          $( ".queryres" ).show("slow");
          },
        })
        .fail(function(response) {
          objstr = 'Failed to retrieve RAMON obj.';
        });
      return objstr;

    }

		// popup on click (querytool)
		var popup = L.popup();
		function onMapClick(e) {
      if (ndv.querytool) {
        var reqPoint = map.project(e.latlng);
        popup
          .setLatLng(e.latlng)
          .setContent( getRamonInfo(reqPoint, map.getMaxZoom() - ndv.upsample_num - map.getZoom()) )
          .openOn(map);
      }
		}
		map.on('click', onMapClick);

    // keyboard shortcuts
    $(document).keypress(function(event) {
      if ( !$(event.target).is('input')) {
        // disable shortcuts if modal is open
        if ($("#remoteModal").hasClass('in') == true) {
          return;
        }
        switch (event.which) {
          case 104: // h -- help
            toggleKeyboardHelp();
            break;
          case 119: // w -- ndv.zindex++
            incZIndex();
            break;
          case 115: // s -- ndv.zindex--
            decZIndex();
            break;
          case 97: // a -- zoom out
            map.zoomOut()
            break;
          case 100: // d -- zoom in
            map.zoomIn()
            break;
          default:
            // do nothing

        }
      }
    });
    function toggleKeyboardHelp() {
      if ($( ".keyhelp" ).css("display") == "none") {
        $( ".keyhelp" ).fadeIn( 1000, function() {
          // Animation complete
        });
      }
      else {
        $( ".keyhelp" ).fadeOut( 500, function() {
          // Animation complete
        });
      }
    }

    // add keyboard help to map
		var keyhelp = L.control();
		keyhelp.options.position = 'bottomleft';
		keyhelp.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'keyhelp');
			this.update();
			return this._div;
		};

		keyhelp.update = function () {
      this._div.innerHTML =
      "<h5>Keyboard Shortcuts</h5><ul class='list-unstyled'>" +
        "<li><kbd>h</kbd> display help</li>" +
        "<li><kbd>w</kbd> increase z-index</li>" +
        "<li><kbd>a</kbd> zoom out</li>" +
        "<li><kbd>s</kbd> decrease z-index</li>" +
        "<li><kbd>d</kbd> zoom in</li>" +
        "</ul><small>Press <kbd>h</kbd> to close.</small>";
		};

    keyhelp.addTo(map);

    // blend mode
    $(function() {
      $('#blendmode').change(function(e) {
        var changed = $(e.target);

        if (changed.is('select[name="blendmode"]')) {
          for (layer in layers) {
            if (layers[layer].type != 'annotation') {
              layers[layer].blending = changed.val();
            }
          }
          ndv.blendmode = changed.val();
          glLayer.draw(); // redraw
        }
      });
    }); // blend mode

    // play delay
    $(function() {
      $('.playdelay-submit').click(function(e) {
        var val = $('.playdelay-input').val();
        ndv.playdelay = val;
      });
    }); // play delay

    // remove a layer
    $(function() {
      $( "#image-sliders" ).on( "click", ".remove-layer", function() {
        var class_arr = this.className.split(' ');
        var layer_name = $.trim(class_arr[1]);
        // remove layer from the map
        console.log(layer_name);
        console.log(layers[layer_name])
        // remove from map
        map.removeLayer( layers[layer_name].tileLayer  );
        // remove from layers array
        delete layers[layer_name]
        // redraw
        glLayer.draw()

        // remove layer from control panel
        $( ".controls-" + layer_name ).remove();
      });
    });

    // close the queryinfo window
    $(function() {
      $( "#closequerybox" ).click(function() {
        $( ".queryres" ).hide( "slow" );
      });
    });

    // timeseries functions
    function loadTimeStep(newTime) {
      map.closePopup();
      if (newTime < {{ starttime }}) {
        $( "#timestep" ).parent().addClass("has-error");
      }
      else if (newTime > {{ endtime }}) {
        $( "#timestep" ).parent().addClass("has-error");
      }
      else {
        $( "#timestep" ).parent().removeClass("has-error");
        for (layer in layers) {
          if (layers[layer].type == 'timeseries') {
            var server = layers[layer].server;
            layers[layer].tileLayer.options.curtime = newTime;
            var newTimeStr = newTime.toString();
            if (layers[layer].tilecache) {
              var newUrl = 'http://' + server + '/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
            }
            else {
              var newUrl = 'http://' + server + '/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
            }
            layers[layer].tileLayer.setUrl(newUrl, true);
            layers[layer].tileLayer.smoothRedraw()();
          }
        }
        glLayer.draw();
      }
    }

    function timeStepForward() {
      map.closePopup();
      for (layer in layers) {
        if (layers[layer].type == 'timeseries') {
          var server = layers[layer].server;
          var curTime = parseInt(layers[layer].tileLayer.options.curtime);
          if (curTime + 1 <= parseInt({{ endtime }})) {
            $( "#timestep" ).parent().removeClass("has-error");
            var newTime = curTime + 1;
            layers[layer].tileLayer.options.curtime = newTime;
            var newTimeStr = newTime.toString();
            if (layers[layer].tilecache) {
              var newUrl = 'http://' + server + '/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
            }
            else {
              var newUrl = 'http://' + server + '/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
            }
            layers[layer].tileLayer.setUrl(newUrl, true);
            layers[layer].tileLayer.smoothRedraw();
          }
          else {
            $( "#timestep" ).parent().addClass("has-error");
          }
        }
      }
      glLayer.draw();
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
	  }

		function timeStepBack() {
      map.closePopup();
      for (layer in layers) {
        if (layers[layer].type == 'timeseries') {
          var server = layers[layer].server;
          var curTime = parseInt(layers[layer].tileLayer.options.curtime);
          if (curTime - 1 >= parseInt({{ starttime }})) {
            $( "#timestep" ).parent().removeClass("has-error");
            var newTime = curTime - 1;
            layers[layer].tileLayer.options.curtime = newTime;
            var newTimeStr = newTime.toString();
            if (layers[layer].tilecache) {
              var newUrl = 'http://' + server + '/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
            }
            else {
              var newUrl = 'http://' + server + '/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
            }
            layers[layer].tileLayer.setUrl(newUrl, true);
            layers[layer].tileLayer.smoothRedraw();
          }
          else {
            $( "#timestep" ).parent().addClass("has-error");
          }
        }
      }
      glLayer.draw();
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
		}

    function timeBeginning() {
      map.closePopup();
      for (layer in layers) {
        if (layers[layer].type == 'timeseries') {
          var server = layers[layer].server;
          var newTimeStr = {{ starttime }};
          layers[layer].tileLayer.options.curtime = newTimeStr;
          if (layers[layer].tilecache) {
            var newUrl = 'http://' + server + '/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          }
          else {
            var newUrl = 'http://' + server + '/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          }
          layers[layer].tileLayer.setUrl(newUrl, true);
          layers[layer].tileLayer.smoothRedraw();
        }
      }
      glLayer.draw();
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
    }

    function timeEnd() {
      map.closePopup();
      for (layer in layers) {
        if (layers[layer].type == 'timeseries') {
          var server = layers[layer].server;
          var newTimeStr = {{ endtime }};
          layers[layer].tileLayer.options.curtime = newTimeStr;
          if (layers[layer].tilecache) {
            var newUrl = 'http://' + server + '/ocptilecache/tilecache/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          }
          else {
            var newUrl = 'http://' + server + '/ocp/catmaid/' + webtoken + '/xy/' + newTimeStr + '/{zindex}/{y}_{x}_{z}.png';
          }
          layers[layer].tileLayer.setUrl(newUrl, true);
          layers[layer].tileLayer.smoothRedraw();
        }
      }
      glLayer.draw();
      // update timestep box
      $( "#timestep" ).val(newTimeStr);
		}

    var play;
    $(function() {
      $( "#play" ).click(function() {
        play = setInterval(function() { timeStepForward(); }, 1000*ndv.playdelay); // 1 second default
      });
    });
    $(function() {
      $( "#pause" ).click(function() {
        clearTimeout(play);
      });
    });
    $(function() {
      $( "#beginning" ).click(function() {
        timeBeginning();
      });
    });
    $(function() {
      $( "#end" ).click(function() {
        timeEnd();
      });
    });
    $(function() {
      $( "#forward" ).click(function() {
        timeStepForward();
      });
    });
    $(function() {
      $( "#back" ).click(function() {
        timeStepBack();
      });
    });

  </script>
  {% if timeseries == True %}

  <footer class="footer">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="timeseries-control-box">
            <div id="timeseries-control-buttons">
              <a href="#" id="beginning"><i class="fa fa-lg fa-backward fa-border"></i></a>

              <a href="#" id="back"><i class="fa fa-lg fa-step-backward fa-border"></i></a>

              <a href="#" id="play"><i class="fa fa-lg fa-play fa-border"></i></a>

              <a href="#" id="pause"><i class="fa fa-lg fa-pause fa-border"></i></a>

              <a href="#" id="forward"><i class="fa fa-lg fa-step-forward fa-border"></i></a>

              <a href="#" id="end"><i class="fa fa-lg fa-forward fa-border"></i></a>
            </div>
            <div>
            <small>Play Delay (sec):</small>
            <input class="playdelay-input" type="number" step="any" min="0" max="100" value="1" />
              <a class="playdelay-submit" href="#"><i class="fa fa-clone fa-lg"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
  {% endif %}

  {# parse options after loading all elements #}
    {% if blendmode %}
    <script>
      // set select box to display correct value
      $( "select[name='blendmode']" ).val("{{ blendmode }}");
      for (layer in layers) {
        if (layers[layer].type != 'annotation') {
          layers[layer].blending = "{{ blendmode }}";
        }
      }
      // track the current blend mode for adding new layers
      ndv.blendmode = "{{ blendmode }}";
      glLayer.draw();
    </script>
    {% endif %}
  {# end parse options #}

  {# after generating the main UI, open dataview, etc #}
  {% if viewtype == 'dataview' %}
    <script>
      $(window).load(function() {
        $( '#remoteModal' ).load("{% url 'renderDataview' dv_token %}")
        $( '#remoteModal' ).modal('show');
      });
    </script>
  {% endif %}
  {% if manage %}
    {% if user.is_authenticated %}
    <script>
      $(window).load(function() {
        $( "#remoteModal" ).load("{% url 'viewProjects' %}");
        $( "#remoteModal" ).modal('show');
      });
    </script>
    {% else %}
    <script>
      $(window).load(function() {
        $( "#login" ).modal('show');
      });
    </script>
    {% endif %}
  {% endif %}

</body>
{# jquery and bootstrap js #}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
{# jquery ui (for slider) #}
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
{# jquery ui on mobile #}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
</html>
